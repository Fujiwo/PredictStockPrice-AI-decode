<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>株価予想 デモ | de:code 2018</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
        h1 {
            position: relative;
            padding: 5px 5px 5px 42px;
            background: #77c3df;
            font-size: 20px;
            color: white;
            margin-left: -33px;
            line-height: 1.3;
            z-index: -1;
        }

        h1:before {
            position: absolute;
            content: '';
            left: -2px;
            top: -2px;
            border: none;
            border-left: solid 40px white;
            border-bottom: solid 79px transparent;
            z-index: -2
        }

        .number {
            text-align: right;
        }
    </style>
</head>
<body>
    <h1>株価予想 デモ | de:code 2018</h1>
    <div>
        <div class="col-12 col-md-auto">
            <span>画像URL:</span>
            <!--
    http://news.tennis365.net/news/photo/kei_546_2017070302.jpg
    https://d2l930y2yx77uc.cloudfront.net/production/uploads/images/3734420/picture_pc_afd8577f1a6ab6095643959ab4cce6f8.jpg
    -->
            <input id="imageUrlTextBox" type="url" value="https://d2l930y2yx77uc.cloudfront.net/production/uploads/images/3734420/picture_pc_afd8577f1a6ab6095643959ab4cce6f8.jpg" />
            <input id="imageUrlButton" type="button" value="検証" />
            <table class="table table-striped">
                <tr>
                    <th>株価 1日目</th>
                    <th>株価 2日目</th>
                    <th>株価 3日目</th>
                    <th>株価 4日目</th>
                    <th>株価 5日目</th>
                    <th>株価 6日目</th>
                    <th>株価 7日目</th>
                    <th>株価 8日目</th>
                    <th>株価 9日目</th>
                    <th>株価10日目</th>
                    <th>株価11日目</th>
                    <th>株価12日目</th>
                    <th>株価13日目</th>
                    <th>株価14日目</th>
                </tr>
                <tr>
                    <td><input id="day1TextBox" type="number" placeholder="株価 1日目"></td>
                    <td><input id="day2TextBox" type="number" placeholder="株価 2日目"></td>
                    <td><input id="day3TextBox" type="number" placeholder="株価 3日目"></td>
                    <td><input id="day4TextBox" type="number" placeholder="株価 4日目"></td>
                    <td><input id="day5TextBox" type="number" placeholder="株価 5日目"></td>
                    <td><input id="day6TextBox" type="number" placeholder="株価 6日目"></td>
                    <td><input id="day7TextBox" type="number" placeholder="株価 7日目"></td>
                    <td><input id="day8TextBox" type="number" placeholder="株価 8日目"></td>
                    <td><input id="day9TextBox" type="number" placeholder="株価 9日目"></td>
                    <td><input id="day10TextBox" type="number" placeholder="株価10日目"></td>
                    <td><input id="day11TextBox" type="number" placeholder="株価11日目"></td>
                    <td><input id="day12TextBox" type="number" placeholder="株価12日目"></td>
                    <td><input id="day13TextBox" type="number" placeholder="株価13日目"></td>
                    <td><input id="day14TextBox" type="number" placeholder="株価14日目"></td>
                </tr>
            </tableclass="table>
            <input id="predictButton" type="button" value="予想" class="btn btn-primary" />
        </div>
        <div>
            <div id="result"></div>
            <div id="image"></div>
        </div>
    </div>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script>
        function tagsToHtml(tags) {
            var tagsHtml = '';
            $.each(
                tags,
                function (index, tag) {
                    tagsHtml += tag + ' ';
                }
            );
            return '<tr><th>タグ</th><td>' + tagsHtml + '</td></tr>';
        }

        function getCaptionText(captions) {
            var captionsText = '';
            $.each(
                captions,
                function (index, caption) {
                    captionsText += caption.text + '. ';
                }
            );
            return captionsText;
        }

        function captionsToHtml(captions) {
            var captionsHtml = '';
            $.each(
                captions,
                function (index, caption) {
                    captionsHtml += '"' + caption.text + '."' + ' (確率: <span class="number">' + (caption.confidence * 100.0).toFixed(3) + '</span><span>%</span>) ';
                }
            );
            return '<tr><th>説明</th><td>' + captionsHtml + '</td></tr>';
        }

        function facesToHtml(faces) {
            var facesHtml = '';
            $.each(
                faces,
                function (index, face) {
                    facesHtml += '年齢: <span class="number">' + face.age + '</span><span>歳</span> 性別: ' + face.gender;
                }
            );
            return '<tr><th>顔</th><td>' + facesHtml + '</td></tr>';
        }

        function predictionsToHtml(predictions) {
            //return JSON.stringify(predictions);
            return '<table class="table table-striped">'
                   + tagsToHtml(predictions.description.tags)
                   + captionsToHtml(predictions.description.captions)
                   + facesToHtml(predictions.faces)
                   + '</table>';
        }

        function imageUrlToHtml(imageUrl, captionText) {
            return '<figure><figcaption>' + captionText + '</figcaption><img src="' + imageUrl + '" alt="画像"></figure>';
        }

        function onImageUrlButtonClick() {
            $('#imageUrlButton').attr("disabled", true);
            $('#result').html('');
            $('#image').html('');

            //headers = { 'Content-Type': 'application/json', 'Authorization': ('Bearer ' + api_key) }
            //var endpoint = "https://southcentralus.api.cognitive.microsoft.com/vision/v1.0";
            var endpoint = "https://ussouthcentral.services.azureml.net/workspaces/f3535c9a53f04c4eb96bb7bdf6808f1a/services/5ff5f716f627422ebd8c804a2ca8fcf4/execute?api-version=2.0&details=true";
            //var subscriptionKey = "d4ecd8dfdc604100951d85d11a7d3511";
            var apiKey = "j6e2zQ0jqr349VroPhlY2IZIwNuipJGnVKOZ7OIXO5QWVQbNzIT+Nqwb0unzFH7a/VhvaxUhDQ5kWrdqc+izig==";
            //var params = {
            //    "visualFeatures": "Description, Faces",
            //    "details": "",
            //    "language": "en",
            //};
            var imageUrl = $('#imageUrlTextBox').val();

            $.ajax({
                url: endpoint /* + $.param(params) */,
                beforeSend: function (xhrObj) {
                    // Request headers
                    xhrObj.setRequestHeader("Content-Type", "application/json");
                    xhrObj.setRequestHeader("Authorization", "Bearer " + apiKey);
                },
                type: "POST",
                data: '{"url": ' + '"' + imageUrl + '"}',
                success: function (predictions) {
                    var captionText = getCaptionText(predictions.description.captions);
                    $('#result').html(predictionsToHtml(predictions));
                    $('#image').html(imageUrlToHtml(imageUrl, captionText));
                },
                error: function () {
                    $('#result').html('<span>エラー: 結果を取得できませんでした。</span>');
                },
                complete: function () {
                    $('#imageUrlButton').attr("disabled", false);
                }
            });
        }

        function main() {
            $('#imageUrlButton').click(onImageUrlButtonClick);
        }

        $(document).ready(main);
    </script>
</body>
</html>
